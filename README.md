# Kubernetes Hard Way - QEMU/libvirt Homelab

This project spins up a minimal Kubernetes cluster following the "Kubernetes The Hard Way" guide using QEMU/KVM, libvirt, and cloud-init. Everything runs locally on AMD64 Linux and uses Debian 12 VMs.

---

## 🗺️ Topology

| Name     | Description              | CPU | RAM   | Storage | IP             |
|----------|--------------------------|-----|-------|---------|----------------|
| jumpbox  | Administration host      | 1   | 512MB | 10GB    | 192.168.122.10 |
| server   | Kubernetes control plane | 1   | 2GB   | 20GB    | 192.168.122.11 |
| node-0   | Kubernetes worker node   | 1   | 2GB   | 20GB    | 192.168.122.21 |
| node-1   | Kubernetes worker node   | 1   | 2GB   | 20GB    | 192.168.122.22 |

---

## 🚀 Quickstart

### Requirements

- Linux with QEMU/KVM & libvirt installed
- `virt-install`, `genisoimage`, `wget`, `make`
- SSH key pair (`~/.ssh/id_rsa.pub` present)

### 1. Download Debian Image

```bash
make create
```

This will:
- Download Debian 12 cloud image
- Generate 4 VM disks
- Inject static IPs and cloud-init user-data
- Start the VMs using `virt-install`

### 2. Access the VMs

```bash
ssh jumpbox
ssh server
ssh node-0
ssh node-1
```

> SSH config is automatically linked to `~/.ssh/config`

### 3. Destroy Everything

```bash
make destroy
```

---

## 📁 File Structure

```
k8s-homelab/
├── Makefile
├── README.md
├── cloud-init/
│   └── user-data.template
├── create-vm-libvirt.sh
├── images/
│   └── debian-12.qcow2  # (downloaded)
├── seed/
│   └── ...              # autogenerated per-VM ISO
├── ssh/
│   └── config
├── vms/
│   └── *.qcow2          # VM disk images
```

---

## 📦 What cloud-init sets up

- Static networking on `ens3`
- Hostname configuration
- `/etc/hosts` populated
- SSH key injection
- `containerd`, `kubeadm`, `kubelet`, `kubectl` installation
- If server:
  - `kubeadm init`
  - kubeconfig setup for `debian` user
- If jumpbox:
  - Only `kubectl` installed

---

## ❓ About genisoimage

`genisoimage` creates an ISO with cloud-init data (`user-data` and `meta-data`) that is attached as a CD-ROM to the VM. This is how the VM gets its initial config on first boot (hostname, IP, packages, etc). Without this, cloud-init would have nothing to read.

---

## 🧪 Extras

- Easily extendable to more nodes or other distros
- Could be modified to use bridged networking
- Perfect for practicing the Kubernetes The Hard Way guide

---

## 🙌 Enjoy hacking Kubernetes the hard (but awesome) way!

If you have improvements or ideas, feel free to fork or adapt it to your own homelab needs.

---
